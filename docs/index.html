<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afinador Crom√°tico de Violino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéª</text></svg>">
    <style>
        /* Define vari√°veis CSS para as cores do tema */
        :root {
            --color-primary: #2dd4bf; /* teal-400 */
            --color-hover: #14b8a6; /* teal-500 */
            --color-accent: #2dd4bf; /* teal-400 */
            --color-bg-button: #2dd4bf; /* teal-400 */
        }

        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Desativa o zoom por duplo toque em dispositivos m√≥veis */
        }
        /* Estilo para a agulha do afinador */
        #needle {
            transform-origin: bottom center;
            transition: transform 0.2s ease-out;
            background-color: var(--color-accent); /* Usa a cor do tema */
        }
        /* Estilo para corda ativa/sugerida */
        .string-button.active {
            ring: 4px solid var(--color-accent); /* Usar√° a cor do tema */
        }
        /* Estilo para corda afinada */
        .string-button.tuned {
            @apply bg-green-600 hover:bg-green-700 text-white;
        }
        /* Estilo para o volume meter */
        #volume-meter-bar {
            transition: width 0.1s ease-out;
            background-color: var(--color-accent); /* Volume meter bar usa a cor do tema */
        }
        /* Estilo para o modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Classes auxiliares para aplicar cores do tema via vari√°veis CSS */
        .theme-color-primary { color: var(--color-primary); }
        .theme-bg-primary { background-color: var(--color-primary); }
        .theme-hover-primary:hover { background-color: var(--color-hover); }

        .theme-color-accent { color: var(--color-accent); }
        .theme-bg-accent { background-color: var(--color-accent); }
        .theme-hover-accent:hover { color: var(--color-accent); } /* Para √≠cones, por exemplo */

        .theme-bg-button { background-color: var(--color-bg-button); }
        .theme-hover-bg-button:hover { background-color: var(--color-hover); }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 text-center space-y-6 relative">

        <h1 class="text-3xl font-bold theme-color-accent">Afinador de Violino</h1>

        <!-- Se√ß√£o de Temas -->
        <div class="flex justify-center items-center space-x-3 text-sm">
            <span class="text-gray-400">Tema:</span>
            <div class="flex space-x-2">
                <button data-theme="teal" class="theme-selector w-6 h-6 rounded-full bg-teal-500 ring-2 ring-transparent hover:ring-white transition-all duration-150" title="Tema Verde-Azulado"></button>
                <button data-theme="blue" class="theme-selector w-6 h-6 rounded-full bg-blue-500 ring-2 ring-transparent hover:ring-white transition-all duration-150" title="Tema Azul"></button>
                <button data-theme="purple" class="theme-selector w-6 h-6 rounded-full bg-purple-500 ring-2 ring-transparent hover:ring-white transition-all duration-150" title="Tema Roxo"></button>
            </div>
        </div>

        <div id="status-message" class="h-10 flex items-center justify-center">
            <p class="text-gray-400">Clique em "Iniciar" para come√ßar</p>
        </div>

        <div class="relative w-full h-40 bg-gray-900/50 rounded-lg overflow-hidden flex items-end justify-center">
            <!-- Linha central -->
            <div class="absolute top-0 bottom-0 w-1 theme-bg-accent/50" style="left: 50%; transform: translateX(-50%);"></div>
            
            <!-- Agulha do afinador -->
            <div id="needle" class="absolute bottom-0 w-1 h-2/3 rounded-t-full" style="transform: rotate(0deg);"></div>

            <!-- Indicadores de cents -->
            <div class="absolute bottom-4 text-xs text-gray-400" style="left: 50%; transform: translateX(-50%);">0</div>
            <div class="absolute bottom-4 text-xs text-gray-500" style="left: 25%; transform: translateX(-50%);">-50</div>
            <div class="absolute bottom-4 text-xs text-gray-500" style="left: 75%; transform: translateX(-50%);">+50</div>

            <!-- Volume Meter (altura reduzida para ser mais sutil) -->
            <div class="absolute top-2 left-2 right-2 h-3 bg-gray-700 rounded-full overflow-hidden">
                <div id="volume-meter-bar" class="h-full rounded-full" style="width: 0%;"></div>
            </div>
        </div>

        <div class="flex items-center justify-center space-x-2">
            <div id="note-name" class="text-8xl font-black text-white tracking-tighter">--</div>
            <div class="flex flex-col text-left">
                <div id="note-sharp-flat" class="text-2xl font-bold theme-color-accent h-8"></div>
                <div id="note-octave" class="text-2xl font-bold text-gray-500"></div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4">
            <!-- Bot√µes de corda sem os bot√µes de reprodu√ß√£o -->
            <button id="string-G3" class="string-button w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150">G3 (Sol)</button>
            <button id="string-D4" class="string-button w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150">D4 (R√©)</button>
            <button id="string-A4" class="string-button w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150">A4 (L√°)</button>
            <button id="string-E5" class="string-button w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-2 rounded-lg transition-all duration-150">E5 (Mi)</button>
        </div>

        <!-- Frequ√™ncia movida para baixo e com texto menor -->
        <div id="frequency-display" class="text-md text-gray-500 h-6 mt-4">Frequ√™ncia: --- Hz</div>

        <button id="toggle-btn" class="w-full theme-bg-primary theme-hover-primary text-gray-900 font-bold py-4 px-4 rounded-xl transition-all duration-200 ease-in-out transform hover:scale-105 shadow-lg">
            Iniciar
        </button>

        <!-- Bot√£o de Ajuda movido para baixo do bot√£o Iniciar -->
        <button id="help-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 ease-in-out transform hover:scale-105 shadow-lg mt-3">
            Ajuda
        </button>
    </div>

    <!-- Modal de Ajuda -->
    <div id="help-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-lg relative text-left space-y-4">
            <h2 class="text-2xl font-bold theme-color-accent mb-4">Como Usar o Afinador</h2>
            <p class="text-gray-300">
                Este afinador de violino foi projetado para ajud√°-lo a afinar seu instrumento de forma precisa e intuitiva.
            </p>
            <ul class="list-disc list-inside text-gray-300 space-y-2">
                <li>
                    <strong>Iniciar/Parar:</strong> Clique no bot√£o "Iniciar" para ativar o microfone e come√ßar a afina√ß√£o. Clique novamente para parar.
                </li>
                <li>
                    <strong>Sequ√™ncia de Afina√ß√£o:</strong> O afinador o guiar√° pela sequ√™ncia padr√£o das cordas do violino (G3, D4, A4, E5). A corda atual a ser afinada estar√° destacada.
                </li>
                <li>
                    <strong>Indicador de Afina√ß√£o:</strong> A agulha central indica o qu√£o perto voc√™ est√° da afina√ß√£o ideal.
                    <ul class="list-circle list-inside ml-4 mt-1">
                        <li>
                            <span class="text-green-400">Verde:</span> Corda afinada (dentro de +/- 10 cents).
                        </li>
                        <li>
                            <span class="text-red-400">Vermelho:</span> Corda fora de afina√ß√£o ou nota incorreta.
                        </li>
                        <li>
                            <span class="theme-color-accent">Cor do Tema:</span> Perto da afina√ß√£o, mas ainda precisa de ajuste.
                        </li>
                    </ul>
                </li>
                <li>
                    <strong>Volume do Microfone:</strong> A barra azul no topo do afinador mostra o n√≠vel de volume captado pelo microfone.
                </li>
                <li>
                    <strong>Temas:</strong> Personalize a cor do afinador clicando nas bolinhas de cor acima do t√≠tulo.
                </li>
            </ul>
            <button id="close-modal-btn" class="w-full theme-bg-button theme-hover-bg-button text-gray-900 font-bold py-3 px-4 rounded-xl transition-all duration-200 ease-in-out shadow-lg mt-4">
                Entendi
            </button>
        </div>
    </div>

    <script>
        // --- Elementos do DOM ---
        const appContainer = document.getElementById('app-container');
        const noteNameEl = document.getElementById('note-name');
        const noteSharpFlatEl = document.getElementById('note-sharp-flat');
        const noteOctaveEl = document.getElementById('note-octave');
        const toggleBtn = document.getElementById('toggle-btn');
        const needle = document.getElementById('needle');
        const statusMessageEl = document.getElementById('status-message');
        const frequencyDisplayEl = document.getElementById('frequency-display');
        const stringButtons = {
            'G3': document.getElementById('string-G3'),
            'D4': document.getElementById('string-D4'),
            'A4': document.getElementById('string-A4'),
            'E5': document.getElementById('string-E5')
        };
        const allStringButtons = document.querySelectorAll('.string-button');
        // Removido: const playNoteButtons = document.querySelectorAll('.play-note-btn');
        const volumeMeterBar = document.getElementById('volume-meter-bar');
        const themeSelectors = document.querySelectorAll('.theme-selector');
        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // --- Vari√°veis de √Åudio e Estado ---
        let audioContext;
        let analyser;
        let mediaStreamSource;
        let buffer;
        let isRunning = false;
        const noteStrings = ["D√≥", "D√≥‚ôØ", "R√©", "R√©‚ôØ", "Mi", "F√°", "F√°‚ôØ", "Sol", "Sol‚ôØ", "L√°", "L√°‚ôØ", "Si"];
        
        const violinStrings = {
            'G3': { name: 'Sol', octave: 3, frequency: 195.998 }, // Sol3
            'D4': { name: 'R√©', octave: 4, frequency: 293.665 }, // R√©4
            'A4': { name: 'L√°', octave: 4, frequency: 440.000 }, // L√°4
            'E5': { name: 'Mi', octave: 5, frequency: 659.255 }  // Mi5
        };
        
        const tuningSequence = ['G3', 'D4', 'A4', 'E5'];
        let currentStringIndex = 0;
        let stringTunedState = { 'G3': false, 'D4': false, 'A4': false, 'E5': false };
        let tuningComplete = false;
        // Removido: let currentOscillator = null; // Para controlar o som de refer√™ncia

        // --- Configura√ß√µes de Tema ---
        const themes = {
            'teal': {
                primary: 'teal-500',
                hover: 'teal-600',
                accent: 'teal-400',
                bg: 'teal-500' // Para o bot√£o do modal
            },
            'blue': {
                primary: 'blue-500',
                hover: 'blue-600',
                accent: 'blue-400',
                bg: 'blue-500'
            },
            'purple': {
                primary: 'purple-500',
                hover: 'purple-600',
                accent: 'purple-400',
                bg: 'purple-500'
            }
        };
        let activeTheme = localStorage.getItem('violinTunerTheme') || 'teal'; // Tema padr√£o

        // --- Fun√ß√µes Auxiliares de √Åudio ---
        function playTunedSound() {
            if (audioContext) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine'; // Onda senoidal para um som suave
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Volume

                oscillator.start(audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5); // Fade out
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        // Removido: function playReferenceNote(frequency) { ... }

        // --- Fun√ß√µes Principais ---

        async function toggleTuner() {
            if (isRunning) {
                stopTuner();
            } else {
                await startTuner();
            }
        }

        async function startTuner() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaStreamSource = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                buffer = new Float32Array(analyser.fftSize);
                
                mediaStreamSource.connect(analyser);

                isRunning = true;
                updateUIOnStart();
                initializeTuningSequence(); // Inicia a sequ√™ncia de afina√ß√£o
                analysePitch();
            } catch (err) {
                console.error('Erro ao aceder ao microfone:', err);
                statusMessageEl.textContent = 'Acesso ao microfone negado.';
                statusMessageEl.classList.add('text-red-400');
            }
        }

        function stopTuner() {
            if (mediaStreamSource) {
                mediaStreamSource.mediaStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null; // Limpa o contexto de √°udio
            }
            // Removido: if (currentOscillator) { ... }
            isRunning = false;
            updateUIOnStop();
        }

        function analysePitch() {
            if (!isRunning) return;

            analyser.getFloatTimeDomainData(buffer);
            const fundamentalFreq = getFundamentalFrequency(buffer, audioContext.sampleRate);

            // Calcula o volume RMS para o volume meter
            let sumSquares = 0;
            for (let i = 0; i < buffer.length; i++) {
                sumSquares += buffer[i] * buffer[i];
            }
            const rms = Math.sqrt(sumSquares / buffer.length);
            // Mapeia RMS para uma largura de 0-100%
            const volumeWidth = Math.min(100, rms * 500); // Ajuste o multiplicador conforme necess√°rio
            volumeMeterBar.style.width = `${volumeWidth}%`;

            if (fundamentalFreq > 0) {
                const noteData = getNoteData(fundamentalFreq);
                updateUINote(noteData, fundamentalFreq);
            } else {
                resetUINoteDisplay(); // Apenas reseta o display da nota, n√£o o estado da UI do afinador
            }
            
            requestAnimationFrame(analysePitch);
        }

        function getFundamentalFrequency(buffer, sampleRate) {
            const correlations = new Array(buffer.length).fill(0);
            for (let i = 0; i < buffer.length; i++) {
                for (let j = 0; j < buffer.length - i; j++) {
                    correlations[i] += buffer[j] * buffer[j + i];
                }
            }

            // Encontra o pico de correla√ß√£o ap√≥s o primeiro cruzamento zero
            let firstZeroCrossing = -1;
            for (let i = 1; i < correlations.length; i++) {
                if (correlations[i - 1] > 0 && correlations[i] <= 0) {
                    firstZeroCrossing = i;
                    break;
                }
            }

            if (firstZeroCrossing === -1) return -1;

            let peakIndex = -1;
            let maxCorrelation = 0;
            // Come√ßa a procurar o pico a partir do primeiro cruzamento zero
            for (let i = firstZeroCrossing; i < correlations.length; i++) {
                if (correlations[i] > maxCorrelation) {
                    maxCorrelation = correlations[i];
                    peakIndex = i;
                }
            }
            
            // Adiciona um limiar para a correla√ß√£o m√°xima para filtrar ru√≠do
            // Se o pico de correla√ß√£o for muito baixo, provavelmente √© ru√≠do
            if (maxCorrelation < 0.1) { // Ajuste este valor conforme necess√°rio (0.1 √© um bom ponto de partida)
                return -1;
            }

            if (peakIndex === -1) return -1;

            const alpha = correlations[peakIndex - 1];
            const beta = correlations[peakIndex];
            const gamma = correlations[peakIndex + 1];
            const peakShift = (alpha - gamma) / (2 * (alpha - 2 * beta + gamma));
            
            return sampleRate / (peakIndex + peakShift);
        }

        function getNoteData(frequency) {
            const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
            const roundedNoteNum = Math.round(noteNum) + 69;
            const idealFrequency = 440 * Math.pow(2, (roundedNoteNum - 69) / 12);
            const cents = 1200 * (Math.log(frequency / idealFrequency) / Math.log(2));
            
            return {
                name: noteStrings[roundedNoteNum % 12],
                octave: Math.floor(roundedNoteNum / 12) - 1,
                cents: cents
            };
        }

        // --- Fun√ß√µes de UI ---

        function updateUIOnStart() {
            toggleBtn.textContent = 'Parar';
            // Remove classes de tema e adiciona vermelho
            toggleBtn.classList.remove('theme-bg-primary', 'theme-hover-primary');
            toggleBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            statusMessageEl.textContent = 'A ouvir...';
            statusMessageEl.classList.remove('text-red-400');
            tuningComplete = false;
        }

        function updateUIOnStop() {
            toggleBtn.textContent = 'Iniciar';
            // Remove vermelho e adiciona classes de tema
            toggleBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            toggleBtn.classList.add('theme-bg-primary', 'theme-hover-primary');
            statusMessageEl.textContent = 'Clique em "Iniciar" para come√ßar';
            resetUINoteDisplay();
            resetStringButtons();
            currentStringIndex = 0; // Reseta para a primeira corda
            tuningComplete = false;
            volumeMeterBar.style.width = '0%'; // Reseta o volume meter
        }

        function resetUINoteDisplay() {
            noteNameEl.textContent = '--';
            noteSharpFlatEl.textContent = '';
            noteOctaveEl.textContent = '';
            needle.style.transform = 'rotate(0deg)';
            needle.style.backgroundColor = '#4a5568'; // gray-700
            noteNameEl.style.color = '#ffffff'; // white
            frequencyDisplayEl.textContent = 'Frequ√™ncia: --- Hz';
        }

        function resetStringButtons() {
            allStringButtons.forEach(button => {
                button.classList.remove('active', 'tuned', 'bg-green-600', 'hover:bg-green-700', 'text-white');
                button.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-white');
            });
            stringTunedState = { 'G3': false, 'D4': false, 'A4': false, 'E5': false }; // Reseta o estado de afina√ß√£o
        }

        function initializeTuningSequence() {
            resetStringButtons(); // Garante que todos os bot√µes est√£o resetados
            currentStringIndex = 0;
            tuningComplete = false;
            highlightCurrentString();
        }

        function highlightCurrentString() {
            allStringButtons.forEach(button => button.classList.remove('active'));
            if (currentStringIndex < tuningSequence.length) {
                const currentStringKey = tuningSequence[currentStringIndex];
                stringButtons[currentStringKey].classList.add('active');
                statusMessageEl.textContent = `Afine a corda ${stringButtons[currentStringKey].textContent.split(' ')[0]} (${stringButtons[currentStringKey].textContent.split(' ')[1].replace(/[()]/g, '')})`;
                statusMessageEl.classList.remove('text-red-400');
                statusMessageEl.classList.add('theme-color-accent'); // Usa a cor do tema
            } else {
                statusMessageEl.textContent = 'Violino Afinad√≠ssimo! üéâ';
                statusMessageEl.classList.remove('theme-color-accent', 'text-red-400');
                statusMessageEl.classList.add('text-green-400');
                tuningComplete = true;
                // N√£o chama stopTuner aqui para permitir o modo crom√°tico ap√≥s a afina√ß√£o
            }
        }
        
        function updateUINote(noteData, frequency) {
            // Se a afina√ß√£o j√° est√° completa, apenas exibe a nota e frequ√™ncia
            if (tuningComplete) {
                noteNameEl.textContent = noteData.name.split('‚ôØ')[0];
                noteSharpFlatEl.textContent = noteData.name.split('‚ôØ').length > 1 ? '‚ôØ' : '';
                noteOctaveEl.textContent = noteData.octave;
                frequencyDisplayEl.textContent = `Frequ√™ncia: ${frequency.toFixed(2)} Hz`;
                const clampedCents = Math.max(-50, Math.min(50, noteData.cents));
                const rotation = (clampedCents / 50) * 60;
                needle.style.transform = `rotate(${rotation}deg)`;
                // Aumenta a toler√¢ncia para "afinada" para +/- 10 cents
                if (Math.abs(clampedCents) < 10) { 
                    needle.style.backgroundColor = 'var(--color-accent)'; // Usa a vari√°vel CSS
                    noteNameEl.style.color = 'var(--color-accent)';
                } else {
                    needle.style.backgroundColor = '#f87171'; // red-400
                    noteNameEl.style.color = '#f87171';
                }
                return; 
            }

            // L√≥gica de afina√ß√£o sequencial
            const currentStringKey = tuningSequence[currentStringIndex];
            const targetStringData = violinStrings[currentStringKey];

            // Atualiza o display da nota geral
            noteNameEl.textContent = noteData.name.split('‚ôØ')[0];
            noteSharpFlatEl.textContent = noteData.name.split('‚ôØ').length > 1 ? '‚ôØ' : '';
            noteOctaveEl.textContent = noteData.octave;
            frequencyDisplayEl.textContent = `Frequ√™ncia: ${frequency.toFixed(2)} Hz`;

            const clampedCents = Math.max(-50, Math.min(50, noteData.cents));
            const rotation = (clampedCents / 50) * 60;
            needle.style.transform = `rotate(${rotation}deg)`;

            // Verifica se a nota detectada √© a corda que deve ser afinada AGORA
            if (noteData.name === targetStringData.name && noteData.octave === targetStringData.octave) {
                // Aumenta a toler√¢ncia para "afinada" para +/- 10 cents
                if (Math.abs(clampedCents) < 10) { 
                    needle.style.backgroundColor = '#10b981'; // green-500
                    noteNameEl.style.color = '#10b981';
                    
                    // Se a corda ainda n√£o foi marcada como afinada
                    if (!stringTunedState[currentStringKey]) {
                        stringTunedState[currentStringKey] = true;
                        stringButtons[currentStringKey].classList.add('tuned');
                        stringButtons[currentStringKey].classList.remove('active');
                        playTunedSound(); // Toca o som de afina√ß√£o
                        statusMessageEl.textContent = `Corda ${stringButtons[currentStringKey].textContent.split(' ')[0]} Afinada! ‚úÖ`;
                        statusMessageEl.classList.remove('theme-color-accent', 'text-red-400');
                        statusMessageEl.classList.add('text-green-400');

                        // Espera um pouco e avan√ßa para a pr√≥xima corda
                        setTimeout(() => {
                            currentStringIndex++;
                            highlightCurrentString();
                            resetUINoteDisplay(); // Limpa o display da nota para a pr√≥xima afina√ß√£o
                        }, 1500); // Espera 1.5 segundos antes de ir para a pr√≥xima
                    }
                } else { // Perto, mas n√£o afinada
                    needle.style.backgroundColor = '#f87171'; // red-400
                    noteNameEl.style.color = '#f87171';
                    statusMessageEl.textContent = `Afine a corda ${stringButtons[currentStringKey].textContent.split(' ')[0]} (${clampedCents.toFixed(0)} cents)`;
                    statusMessageEl.classList.remove('text-green-400', 'text-red-400');
                    statusMessageEl.classList.add('theme-color-accent'); // Voltar para a cor do tema se estiver perto
                }
            } else { // N√£o √© a corda atual ou est√° muito fora
                needle.style.backgroundColor = '#f87171'; // red-400
                noteNameEl.style.color = '#f87171';
                statusMessageEl.textContent = `Procure a corda ${stringButtons[currentStringKey].textContent.split(' ')[0]} (${stringButtons[currentStringKey].textContent.split(' ')[1].replace(/[()]/g, '')})`;
                statusMessageEl.classList.remove('text-green-400');
                statusMessageEl.classList.add('text-red-400');
            }
        }

        // --- Fun√ß√µes de Tema ---
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;

            // Define as vari√°veis CSS com as cores do tema selecionado
            document.documentElement.style.setProperty('--color-primary', getComputedStyle(document.documentElement).getPropertyValue(`--tw-colors-${theme.primary.replace('-', '')}`));
            document.documentElement.style.setProperty('--color-hover', getComputedStyle(document.documentElement).getPropertyValue(`--tw-colors-${theme.hover.replace('-', '')}`));
            document.documentElement.style.setProperty('--color-accent', getComputedStyle(document.documentElement).getPropertyValue(`--tw-colors-${theme.accent.replace('-', '')}`));
            document.documentElement.style.setProperty('--color-bg-button', getComputedStyle(document.documentElement).getPropertyValue(`--tw-colors-${theme.bg.replace('-', '')}`));

            // Marca o seletor de tema ativo
            themeSelectors.forEach(selector => selector.classList.remove('ring-4', 'ring-teal-400', 'ring-blue-400', 'ring-purple-400'));
            document.querySelector(`[data-theme="${themeName}"]`).classList.add('ring-4', `ring-${theme.accent}`);

            activeTheme = themeName;
            localStorage.setItem('violinTunerTheme', themeName);
            
            // Re-highlight a corda atual para aplicar a nova cor do tema se a afina√ß√£o estiver ativa
            if (isRunning && !tuningComplete) {
                highlightCurrentString();
            } else if (!isRunning) {
                // Se n√£o estiver rodando, garante que agulha e nome da nota voltem ao padr√£o cinza
                needle.style.backgroundColor = '#4a5568'; // gray-700
                noteNameEl.style.color = '#ffffff'; // white
            }
            // Atualiza a cor da mensagem de status se aplic√°vel
            if (!statusMessageEl.classList.contains('text-red-400') && !statusMessageEl.classList.contains('text-green-400')) {
                statusMessageEl.classList.remove('text-teal-400', 'text-blue-400', 'text-purple-400'); // Remove classes antigas
                statusMessageEl.classList.add('theme-color-accent'); // Adiciona a nova classe de tema
            }
        }

        // --- Event Listeners ---
        toggleBtn.addEventListener('click', toggleTuner);
        helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => helpModal.classList.add('hidden'));

        // Removido: Event listeners para os bot√µes de reprodu√ß√£o de nota
        // playNoteButtons.forEach(button => { ... });

        // Event listeners para os seletores de tema
        themeSelectors.forEach(selector => {
            selector.addEventListener('click', (event) => {
                const themeName = event.target.dataset.theme;
                applyTheme(themeName);
            });
        });

        // Aplica o tema salvo ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(activeTheme);
        });

    </script>
</body>
</html>
